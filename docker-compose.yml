services:
  kafka:
    container_name: kafka
    networks:
      melosys.docker-internal:
        aliases:
          - kafka.melosys.docker-internal
    image: confluentinc/cp-kafka:7.8.0
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      # KRaft mode configuration
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka.melosys.docker-internal:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listener configuration
      KAFKA_LISTENERS: PLAINTEXT://kafka.melosys.docker-internal:9092,PLAINTEXT_HOST://0.0.0.0:29092,CONTROLLER://kafka.melosys.docker-internal:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka.melosys.docker-internal:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Replication settings
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0

      # Log directory
      KAFKA_LOG_DIRS: /var/lib/kafka/data

      # Cluster ID (required for KRaft)
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    entrypoint: [ "/scripts/kafka-entrypoint.sh" ]
    volumes:
      - ./scripts/kafka-entrypoint.sh:/scripts/kafka-entrypoint.sh
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD-SHELL", "nc -z kafka.melosys.docker-internal 9092" ]
      interval: 10s
      timeout: 5s
      retries: 30

  mock-oauth2-server:
    image: ghcr.io/navikt/mock-oauth2-server:2.3.0
    hostname: host.docker.internal
    networks:
      melosys.docker-internal:
        aliases:
          - host.docker.internal
    environment:
      SERVER_PORT: 8082
      JSON_CONFIG: '{
    "interactiveLogin": true,
    "tokenCallbacks": [
        {
            "issuerId": "isso",
            "tokenExpiry": 120,
            "requestMappings": [
                {
                    "requestParam": "scope",
                    "match": "melosys-localhost",
                    "claims": {
                        "roles": [
                            "faktureringskomponenten-skriv"
                        ],
                        "sub": "melosys-api",
                        "aud": "melosys-localhost",
                        "azp": "melosys-api",
                        "iss": "http://host.docker.internal:8082/isso",
                        "tid": "isso"
                    }
                },
                {
                    "requestParam": "audience",
                    "match": "melosys-localhost",
                    "claims": {
                        "roles": [
                            "faktureringskomponenten-skriv"
                        ],
                        "sub": "melosys-api",
                        "aud": "melosys-localhost",
                        "azp": "melosys-api",
                        "iss": "http://host.docker.internal:8082/isso",
                        "tid": "isso"
                    }
                },
                {
                    "requestParam": "audience",
                    "match": "melosys-skjema-api",
                    "claims": {
                        "roles": [
                            "faktureringskomponenten-skriv"
                        ],
                        "pid": "$${pid}",
                        "aud": "$${audience}",
                        "sub": "$${pid}",
                        "azp": "$${clientId}",
                        "iss": "http://host.docker.internal:8082/isso",
                        "tid": "isso"
                    }
                }                
            ]
        }       
    ]
}'
    ports:
      - "8082:8082"

  mock-oauth2-server-sts:
    image: ghcr.io/navikt/mock-oauth2-server:0.4.8
    hostname: host.docker.internal.sts
    environment:
      SERVER_PORT: 8086
      JSON_CONFIG: '{
        "interactiveLogin": false,
        "httpServer": "NettyWrapper",
        "tokenCallbacks": [
          {
            "issuerId": "reststs",
            "tokenExpiry": 12000,
            "requestMappings": [
              {
                "requestParam": "grant_type",
                "match": "client_credentials",
                "claims": {
                  "sub": "15084300133",
                  "sid": "1234",
                  "aud": "srvmelosys",
                  "acr": "Level4"
                }
              }
            ]
          }
          ]
        }'
    ports:
      - "8086:8086"
    networks:
      melosys.docker-internal:
        aliases:
          - host.docker.internal.sts

  melosys-mock:
    container_name: melosys-mock
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-docker-compose-mock:${MELOSYS_MOCK_TAG:-latest}
    ports:
      - "8083:8083"
      - "8389:8389"
    environment:
      SPRING_PROFILES_ACTIVE: local-docker
    volumes:
      - ./mock-resources:/files
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-mock.melosys.docker-internal

  faktureringskomponenten:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/faktureringskomponenten:${FAKTURERINGSKOMPONENTEN_TAG:-latest}
    container_name: faktureringskomponenten
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/postgres?currentSchema=faktureringskomponenten"
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: mysecretpassword
      SPRING_FLYWAY_ENABLED: "true"
      KAFKA_BROKERS: "kafka.melosys.docker-internal:9092"
      UNLEASH_URL: "http://unleash.melosys.docker-internal:4242/api"
      UNLEASH_TOKEN: "*:development.unleash-insecure-client-api-token"
      UNLEASH_APP_NAME: "faktureringskomponenten"
      UNLEASH_ENVIRONMENT: "development"
    networks:
      melosys.docker-internal:
        aliases:
          - faktureringskomponenten.melosys.docker-internal
    ports:
      - "8084:8084"

  melosys-dokgen:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-dokgen:latest
    container_name: melosys-dokgen
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-dokgen.melosys.docker-internal
    ports:
      - "8888:8080"

  melosys-trygdeavgift-beregning:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-trygdeavgift-beregning:${MELOSYS_TRYGDEAVGIFT_TAG:-latest}
    container_name: melosys-trygdeavgift-beregning
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/postgres?currentSchema=trygdeavgift-beregning"
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: mysecretpassword
      SPRING_FLYWAY_ENABLED: "true"
      KAFKA_BROKERS: "kafka.melosys.docker-internal:9092"
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-trygdeavgift-beregning.melosys.docker-internal
    ports:
      - "8095:8095"

  melosys-api:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-api:${MELOSYS_API_TAG:-latest}
    container_name: melosys-api
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-api.melosys.docker-internal
    ports:
      - "8080:8080"
      - "6300:6300"  # JaCoCo coverage port
    volumes:
      - ./jacoco:/jacoco:ro  # Mount JaCoCo agent (optional, for E2E coverage)
    depends_on:
      - kafka
      - mock-oauth2-server
      - mock-oauth2-server-sts
      - melosys-mock
      - melosys-eessi
      - faktureringskomponenten
      - melosys-dokgen
      - melosys-trygdeavgift-beregning
    environment:
      SPRING_PROFILES_ACTIVE: local-mock
      # JaCoCo coverage agent (optional - only set in CI for E2E coverage)
      JAVA_TOOL_OPTIONS: ${JACOCO_AGENT_OPTS:-}
      # Kafka configuration
      KAFKA_BROKERS: kafka.melosys.docker-internal:9092
      # Oracle database configuration (override localhost with docker service name)
      SPRING_DATASOURCE_URL: jdbc:oracle:thin:@//melosys-oracle:1521/${MELOSYS_ORACLE_DB_NAME:-freepdb1} # We need freepdb1 for Mac ARM and XEPDB1 for Intel/GitHub Actions
      # Override service URLs to use docker network aliases instead of localhost
      DISTRIBUERJOURNALPOST_V1_URL: http://melosys-mock.melosys.docker-internal:8083/rest/v1/distribuerjournalpost
      DOKUMENTPRODUKSJON_V3_URL: http://melosys-mock.melosys.docker-internal:8083/soap/services/dokumentproduksjon/v3
      JOURNALPOSTAPI_V1_URL: http://melosys-mock.melosys.docker-internal:8083/rest/journalpostapi/v1
      KODEVERKAPI_V1_URL: http://felles-kodeverk.melosys.docker-internal:8050/api
      MELOSYSEESSI_URL: http://melosys-eessi.melosys.docker-internal:8081/api
      OPPGAVEAPI_V1_URL: http://melosys-mock.melosys.docker-internal:8083/api/v1
      PDL_URL: http://melosys-mock.melosys.docker-internal:8083/graphql
      REST_STS_URL: http://host.docker.internal.sts:8086/reststs
      SAF_URL: http://melosys-mock.melosys.docker-internal:8083
      SAKAPI_V1_URL: http://melosys-mock.melosys.docker-internal:8083/api/v1/saker
      SAKOGBEHANDLING_V1_URL: http://melosys-mock.melosys.docker-internal:8083/soap/services/sakOgBehandling/v1
      ARBEIDSFORHOLD_REST_URL: http://melosys-mock.melosys.docker-internal:8083/aareg-services/api/v1/arbeidstaker/arbeidsforhold
      EREG_REST_URL: http://melosys-mock.melosys.docker-internal:8083/ereg/v2
      FAKTURERINGSKOMPONENTEN_URL: http://faktureringskomponenten.melosys.docker-internal:8084
      INNTEKT_REST_URL: http://melosys-mock.melosys.docker-internal:8083/inntektskomponenten/rs/api/v1
      MEDLEMSKAP_REST_URL: http://melosys-mock.melosys.docker-internal:8083
      MELOSYSDOKGEN_V1_URL: http://melosys-dokgen.melosys.docker-internal:8080/api/v1
      MELOSYSTRYGDEAVGIFT_URL: http://melosys-trygdeavgift-beregning.melosys.docker-internal:8095/api
      INNGANGSVILKAAR_URL: http://melosys-inngangsvilkar.melosys.docker-internal:8080/api
      MICROSOFT_GRAPH_REST_URL: http://melosys-mock.melosys.docker-internal:8083/graph/v1.0
      TILGANGSMASKINEN_URL: http://melosys-mock.melosys.docker-internal:8083/tilgangsmaskinen
      UTBETALING_REST_URL: http://melosys-mock.melosys.docker-internal:8083/utbetaldata/api/v2/hent-utbetalingsinformasjon/intern
      # Unleash feature toggle configuration
      UNLEASH_URL: "http://unleash.melosys.docker-internal:4242/api"
      UNLEASH_TOKEN: "*:development.unleash-insecure-client-api-token"
      UNLEASH_APP_NAME: "melosys-api"
      UNLEASH_ENVIRONMENT: "development"

  melosys-web:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-web:${MELOSYS_WEB_TAG:-latest}
    container_name: melosys-web
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-web.melosys.docker-internal
    ports:
      - "3000:3000"
    depends_on:
      - melosys-api
      - mock-oauth2-server
      - faktureringskomponenten
    environment:
      # Load the local environment configuration
      ENVIRONMENT_NAME: local
      # Nginx proxy configuration - these are used in the nginx template
      APP_URL_MELOSYS: http://melosys-api.melosys.docker-internal:8080
      APP_URL_FAKTURERINGSKOMPONENTEN: http://faktureringskomponenten.melosys.docker-internal:8084
      APP_URL_TRYGDEAVTALE: http://melosys-trygdeavtale.melosys.docker-internal:8088

  postgres_felleskodeverk:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/postgres-felleskodeverk-prepopulated:latest
    container_name: postgres_felleskodeverk
    networks:
      melosys.docker-internal:
        aliases:
          - postgres_felleskodeverk.melosys.docker-internal
    ports:
      - "5433:5432"

  felles-kodeverk:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/felles-kodeverk:latest
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres_felleskodeverk.melosys.docker-internal:5432/felles-kodeverk"
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: mysecretpassword
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://host.docker.internal:8082/isso
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_AUDIENCES: melosys-localhost
      KODEVERKPRODUKTEIER_AAD_GRP_ID: 0000-GA-MELOSYS
      SPRING_FLYWAY_ENABLED: "false"  # Flyway disabled since data is already in the image
      SPRING_LOGGING_LEVEL_ROOT: TRACE
    entrypoint: "/app/entrypoint.sh"
    depends_on:
      - postgres_felleskodeverk
    volumes:
      - ./felles-kodeverk/felles-kodeverk-entrypoint.sh:/app/entrypoint.sh
    networks:
      melosys.docker-internal:
        aliases:
          - felles-kodeverk.melosys.docker-internal
    ports:
      - "8050:8050"

  melosys-oracle:
    image: ${ORACLE_IMAGE:-gvenzl/oracle-xe:18.4.0-slim}
    container_name: melosys-oracle
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-oracle.melosys.docker-internal
    environment:
      APP_USER: melosys
      APP_USER_PASSWORD: melosyspwd
      ORACLE_PASSWORD: oracle
    ports:
      - "1521:1521"
    # Note: gvenzl/oracle-xe has a built-in healthcheck, but we define it explicitly here
    # for visibility and to ensure consistent behavior across environments
    healthcheck:
      test: ["CMD", "/opt/oracle/healthcheck.sh"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 60s

  postgres:
    image: postgres:13-alpine
    container_name: postgres
    networks:
      melosys.docker-internal:
        aliases:
          - postgres.melosys.docker-internal
          - postgres
    environment:
      POSTGRES_PASSWORD: mysecretpassword
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  unleash:
    image: unleashorg/unleash-server:latest
    container_name: unleash
    ports:
      - "4242:4242"
    environment:
      DATABASE_HOST: postgres.melosys.docker-internal
      DATABASE_NAME: postgres
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: mysecretpassword
#      DATABASE_SCHEMA: unleash
      DATABASE_SSL: "false"
      LOG_LEVEL: info
      INIT_ADMIN_API_TOKENS: "*:*.unleash-insecure-api-token"
      INIT_CLIENT_API_TOKENS: "*:development.unleash-insecure-client-api-token"
    networks:
      melosys.docker-internal:
        aliases:
          - unleash.melosys.docker-internal
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4242/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  melosys-trygdeavtale:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-trygdeavtale:${MELOSYS_TRYGDEAVTALE_TAG:-latest}
    container_name: melosys-trygdeavtale
    depends_on:
      - mock-oauth2-server
      - postgres
      - melosys-api
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-trygdeavtale.melosys.docker-internal
    environment:
      SPRING_PROFILES_ACTIVE: local-docker
      JDBC_URL: jdbc:postgresql://postgres:5432/postgres
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/postgres?currentSchema=melosys-trygdeavtale"
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: mysecretpassword
      MELOSYS_API_URL: http://melosys-api.melosys.docker-internal:8080
      ABAC_PDP_ENDPOINT_URL: http://melosys-mock:8083/asm-pdp/authorize
    ports:
      - "8088:8088"

  melosys-inngangsvilkar:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-inngangsvilkar:${MELOSYS_INNGANGSVILKAR_TAG:-latest}
    container_name: melosys-inngangsvilkar
    depends_on:
      - mock-oauth2-server
      - postgres
      - melosys-api
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-inngangsvilkar.melosys.docker-internal
    environment:
      SPRING_PROFILES_ACTIVE: local-docker
      JDBC_URL: jdbc:postgresql://postgres:5432/postgres
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/postgres?currentSchema=melosys-inngangsvilkar"
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: mysecretpassword
      MELOSYS_API_URL: http://melosys-api.melosys.docker-internal:8080
      ABAC_PDP_ENDPOINT_URL: http://melosys-mock:8083/asm-pdp/authorize
    ports:
      - "8089:8080"

  # ============================================================================
  # EESSI Integration
  # ============================================================================

  melosys-eessi:
    image: europe-north1-docker.pkg.dev/nais-management-233d/teammelosys/melosys-eessi:${MELOSYS_EESSI_TAG:-latest}
    container_name: melosys-eessi
    depends_on:
      - kafka
      - mock-oauth2-server
      - mock-oauth2-server-sts
      - melosys-mock
      - postgres
      - unleash
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: local-mock
      # Server port (matches local-mock profile)
      SERVER_PORT: 8081
      # Database configuration
      PG_HOST: postgres.melosys.docker-internal
      DATABASE_NAME: postgres
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: mysecretpassword
      SPRING_DATASOURCE_HIKARI_SCHEMA: eessi
      # Integration URLs (pointing to mock service)
      EUX_RINA_API_URL: http://melosys-mock.melosys.docker-internal:8083/eux
      EUXAPP_RINASAKER_URL: dummy
      RINA_HOST_URL: dummy
      EUXCASESTORE_URL: http://melosys-mock.melosys.docker-internal:8083/eux_casestore
      RESTSTS_URL: http://host.docker.internal.sts:8086/reststs
      SAK_URL: http://melosys-mock.melosys.docker-internal:8083/api/v1/saker
      JOURNALPOSTAPI_URL: http://melosys-mock.melosys.docker-internal:8083/rest/journalpostapi/v1/journalpost
      OPPGAVE_URL: http://melosys-mock.melosys.docker-internal:8083/api/v1
      SAF_URL: http://melosys-mock.melosys.docker-internal:8083
      PDL_URL: http://melosys-mock.melosys.docker-internal:8083/graphql
      PDL_WEB_URL: http://melosys-mock.melosys.docker-internal:8083
      # RINA config
      RINA_INSTITUSJON_ID: dummy
      # Admin API key
      MELOSYS_ADMIN_API_KEY: dummy
      # System user credentials
      SRV_USERNAME: srvmelosys
      SRV_PASSWORD: dummy
      # OAuth / Azure AD configuration
      AZURE_APP_CLIENT_ID: melosys-localhost
      AZURE_APP_CLIENT_SECRET: dummy
      AZURE_APP_WELL_KNOWN_URL: http://host.docker.internal:8082/isso/.well-known/openid-configuration
      AZURE_OPENID_CONFIG_TOKEN_ENDPOINT: http://host.docker.internal:8082/isso/token
      # OAuth scopes (dummy values for local-mock)
      EUX_RINA_API_SCOPE: dummy
      EUX_NAV_RINASAK_SCOPE: dummy
      PDL_WEB_SCOPE: dummy
      PDL_SCOPE: dummy
      OPPGAVE_API_SCOPE: dummy
      SAF_SCOPE: dummy
      # Kafka configuration
      KAFKA_BOOTSTRAP_SERVERS: kafka.melosys.docker-internal:9092
      KAFKA_BROKERS: kafka.melosys.docker-internal:9092
      KAFKA_KEYSTORE_PATH: /dev/zero
      KAFKA_TRUSTSTORE_PATH: /dev/zero
      KAFKA_CREDSTORE_PASSWORD: pwd
      # Kafka topics
      KAFKA_AIVEN_SEDMOTTATT_TOPIC: eessibasis-sedmottatt-v1-local
      KAFKA_AIVEN_SEDSENDT_TOPIC: eessibasis-sedsendt-v1
      KAFKA_AIVEN_SEDHENDELSER_MOTTATT_GROUPID: melosys-eessi-sedHendelser-local
      KAFKA_AIVEN_SEDHENDELSER_SENDT_GROUPID: melosys-eessi-sedHendelser-local
      KAFKA_AIVEN_OPPGAVE_HENDELSE_GROUPID: melosys-eessi-oppgaveHendelser-local
      KAFKA_AIVEN_OPPGAVE_HENDELSE_TOPIC: oppgavehandtering.oppgavehendelse-v1
      KAFKA_AIVEN_EESSIMELDING_TOPIC: teammelosys.eessi.v1-local
      KAFKA_OPPGAVE_GROUPID: melosys-eessi-oppgaveHendelser-local
      KAFKA_OPPGAVE_ENDRET_TOPIC: teammelosys.eessi.oppgave-endret.v1-local
      # Kafka security (plaintext for local)
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
      # Cron job (disabled - run only Jan 1 at 00:00)
      CRON_JOB_LUKK_BUC: "0 0 0 1 1 *"
      # Unleash
      UNLEASH_SERVER_API_URL: "http://unleash.melosys.docker-internal:4242"
      UNLEASH_SERVER_API_TOKEN: "*:development.unleash-insecure-client-api-token"
    networks:
      melosys.docker-internal:
        aliases:
          - melosys-eessi.melosys.docker-internal

networks:
  melosys.docker-internal:
    external: true

volumes:
  kafka-data:
