# E2E Failure Analysis - Implementation Notes

## Overview

This PR implements automated E2E test failure analysis using GitHub Actions workflows and GitHub Copilot.

## What Was Implemented

### 1. Modified E2E Tests Workflow
- **File:** `.github/workflows/e2e-tests.yml`
- **Changes:**
  - Added job outputs: `test-status`, `has-failures`, `has-flaky`
  - Added "Set test status outputs" step to parse test results
  - Enables downstream workflows to react to test failures

### 2. New Analyze E2E Failures Workflow
- **File:** `.github/workflows/analyze-e2e-failures.yml`
- **Features:**
  - Automatic trigger when E2E Tests complete
  - Manual trigger with workflow run ID
  - Downloads test-summary artifact
  - Creates/updates GitHub issues for failures
  - Includes comprehensive error context

### 3. New Copilot Analyze Failure Workflow
- **File:** `.github/workflows/copilot-analyze-failure.yml`
- **Features:**
  - Triggers when `copilot-analyze` label is added to issue
  - Adds @copilot comment with analysis instructions
  - Copilot searches melosys-api and melosys-web repositories
  - Provides classification and fix suggestions

## Key Features

✅ **Automatic Detection** - Runs on every E2E test completion
✅ **Smart Deduplication** - Updates existing issues instead of creating duplicates
✅ **Rich Context** - Includes errors, Docker logs, image tags, workflow links
✅ **AI-Powered Analysis** - Copilot helps classify and suggest fixes
✅ **Manual Re-analysis** - Can re-analyze any workflow run

## How to Use

### When Tests Fail (Fully Automatic)
1. E2E tests run and fail
2. Issue is automatically created with `e2e-failure`, `needs-triage`, and `copilot-analyze` labels
3. Issue contains full error context
4. Copilot automatically analyzes and adds a comment with findings
5. Review Copilot's analysis and apply recommendations

### Manual Re-analysis
1. Go to Actions → Analyze E2E Failures
2. Click "Run workflow"
3. Enter the workflow run ID
4. Click "Run workflow"

## Documentation

- **[E2E Failure Analysis Guide](docs/ci-cd/E2E-FAILURE-ANALYSIS.md)** - Complete documentation
- **[Workflow Diagram](docs/ci-cd/E2E-FAILURE-ANALYSIS-DIAGRAM.md)** - Visual flow diagram

## Technical Details

### Permissions
All workflows have appropriate permissions configured:
- `contents: read` - Read repository content
- `actions: read` - Download artifacts
- `issues: write` - Create and comment on issues

### Labels Used
- `e2e-failure` - All E2E test failure issues (auto-applied)
- `needs-triage` - New issues needing review (auto-applied)
- `copilot-analyze` - Trigger for Copilot analysis (auto-applied)
- `test-bug` - Issue in test code (Copilot suggests)
- `production-bug` - Issue in application code (Copilot suggests)
- `flaky-test` - Timing/race condition (Copilot suggests)

### Test Summary Format
The workflows use `test-summary.json` which follows the `TestSummaryData` interface:
- Contains test results (passed, failed, flaky, known-error)
- Includes Docker errors per service
- Includes image tags used in the run
- Generated by the custom Playwright reporter

## Testing & Validation

✅ All YAML validated with Python parser
✅ jq commands tested with sample data
✅ Issue creation logic verified
✅ Edge cases considered and handled

## Future Enhancements

Potential improvements:
- Auto-close issues when tests pass consistently
- Track failure frequency/history
- Slack notifications for new failures
- Auto-apply labels based on Copilot classification
- Link to related PRs that introduced failures

## Files Changed

```
.github/workflows/analyze-e2e-failures.yml    | 211 ++++++
.github/workflows/copilot-analyze-failure.yml |  69 ++
.github/workflows/e2e-tests.yml               |  40 +-
README.md                                     |   1 +
docs/ci-cd/E2E-FAILURE-ANALYSIS-DIAGRAM.md    |  92 +++
docs/ci-cd/E2E-FAILURE-ANALYSIS.md            | 343 ++++++
6 files changed, 756 insertions(+)
```

## Next Steps

The workflows are ready to use:
1. Merge this PR
2. Wait for next E2E test failure (or trigger manually)
3. Review auto-created issues
4. Add `copilot-analyze` label to get AI analysis
5. Apply Copilot's suggested fixes

---

**Implementation Date:** December 22, 2025
**Status:** ✅ Complete and Ready for Use
